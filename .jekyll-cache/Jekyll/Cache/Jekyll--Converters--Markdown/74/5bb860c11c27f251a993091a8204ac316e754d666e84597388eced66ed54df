I"•&<p>In my <a href="azure-blob-website/">last post</a> I went over why I thought blob storage was a really cool option for hosting your static webpage. If you haven‚Äôt read it, check that one out before continuing. This post will be outlining a way you can do continuous delivery to your Azure storage account using Travis CI and GitHub. I‚Äôll show you how you can get an impressive amount of automation, and a highly scalable website for a very, very low cost. The below commands are written in Powershell, and some may need tweaking for bash.</p>

<h3 id="heres-the-plan">Here‚Äôs the plan:</h3>
<p>We‚Äôre going to use the <a href="https://cli.angular.io/">Angular CLI</a> to make a simple Angular website, check our code into a <a href="https://github.com">GitHub</a> repository, and use <a href="https://travis-ci.org/">Travis CI</a> to continuously build and deploy our app to Azure Blob storage for every commit to our master branch. We‚Äôll keep it simple here, but the sky is the limit!</p>

<h3 id="prerequisites-follow-the-links-if-you-need-help">Prerequisites (follow the links if you need help)</h3>
<ol>
  <li>An <a href="https://azure.microsoft.com/en-us/free/">Azure account</a>. (You can get a free trial if you don‚Äôt already have one).</li>
  <li><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Azure command line interface (CLI)</a> We need this to make a few things easier. Make sure you login to your account with ‚Äúaz login‚Äù</li>
  <li>A text editor. It doesn‚Äôt matter which one, but I personally like <a href="https://code.visualstudio.com/">Visual Studio Code</a>.</li>
  <li>A <a href="https://github.com">GitHub</a> account and <a href="https://git-scm.com/">git</a>. If you don‚Äôt have these already, you‚Äôre missing out!</li>
  <li><a href="https://travis-ci.org/">Travis CI</a> account linked to your GitHub account. This is easy, just follow the instructions on the Travis site.</li>
  <li><a href="https://cli.angular.io/">Angular CLI</a> so we can make a quick Angular app to deploy</li>
</ol>

<h3 id="ready-lets-go">Ready? Let‚Äôs go!</h3>
<ol>
  <li>First things first. We‚Äôre going to hop into the command line, and make an Angular app. change to a directory where you keep your projects and run the following command:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># use angular CLI to make a new app with a routing module</span>
ng new azure-blob <span class="nt">--routing</span>
</code></pre></div>    </div>
  </li>
  <li>Serve the website locally to see what it looks like. You can close the server with Ctrl+C in the command line when you‚Äôre done
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># change to your app's directory</span>
<span class="nb">cd</span> ./azure-blob
<span class="c"># compile and serve the app locally, this should open in a browser</span>
ng serve <span class="nt">--open</span>
</code></pre></div>    </div>
  </li>
  <li>Create a new GitHub repository, and push the project.
    <ol>
      <li>login to GitHub, and click the ‚Äú+‚Äù icon in the top right corner, select ‚ÄúNew repository.‚Äù</li>
      <li>Call it ‚Äúazure-blob‚Äù and leave the other settings default. It should be a public repo, with no README or .gitignore.</li>
      <li>Click ‚ÄúCreate Repository‚Äù</li>
      <li>leave the browser open to the next page. You need to run the instructions to ‚Äúpush an existing repository from the command line‚Äù in the next step.</li>
    </ol>
  </li>
  <li>Push your Angular application to GitHub.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git remote add origin https://github.com/<span class="o">{</span>YOUR_USERNAME<span class="o">}</span>/azure-blob.git
git push <span class="nt">-u</span> origin master
</code></pre></div>    </div>
  </li>
  <li>Link Travis CI
    <ol>
      <li>Log into the travis CI website, go to your profile, and click the ‚ÄúSync Account‚Äù button. After a few seconds, your sync should complete, and you can refresh the page for an updated list.</li>
      <li>Find the ‚Äúazure-blob‚Äù repo, and enable it, then click the ‚ÄúSettings‚Äù button.</li>
      <li>There are a lot of options you can setup in Travis on this screen, we‚Äôll leave most of them default. But keep the settings page open for the next few steps.</li>
    </ol>
  </li>
  <li>Create an Azure Storage account (you can do this via the portal like I outlined in the <a href="azure-blob-website/">last post</a>, or use the command line like I do here)
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># add the extension (since it's in preview)</span>
az extension add <span class="nt">--name</span> storage-preview
<span class="c"># create a resource group</span>
az group create <span class="nt">--name</span> azure-blob-demo <span class="nt">--location</span> westus
<span class="c"># create a storage account. Must be "StorageV2"</span>
<span class="c"># you will need to create a unique name here.</span>
<span class="c"># everywhere I reference "thenickfishazureblobdemo" substitute your own</span>
az storage account create <span class="nt">--name</span> thenickfishazureblobdemo <span class="nt">--resource-group</span> azure-blob-demo <span class="nt">--location</span> westus <span class="nt">--sku</span> Standard_LRS <span class="nt">--encryption</span> blob <span class="nt">--kind</span> StorageV2
<span class="c"># enable static website hosting, and set the index document</span>
az storage blob service-properties update <span class="nt">--account-name</span> thenickfishazureblobdemo <span class="nt">--static-website</span> <span class="nt">--index-document</span> index.html
</code></pre></div>    </div>
  </li>
  <li>Create a scoped account for Travis CI to use. This is technically optional, but a very good idea. Just in case Travis (or any other system for that matter) ever gets compromised, you want the account being used to have minimal rights.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># get your subscription id</span>
<span class="nv">$env</span>:subscriptionId<span class="o">=(</span>az account show <span class="nt">--query</span> <span class="nb">id</span> <span class="nt">-o</span> tsv<span class="o">)</span>
<span class="c"># create rbac scoped to just our new resource group</span>
az ad sp create-for-rbac <span class="nt">--name</span> travis-azure-blob <span class="nt">--scope</span> <span class="s2">"/subscriptions/</span><span class="nv">$env</span><span class="s2">:subscriptionId/resourceGroups/azure-blob-demo"</span>
<span class="c"># keep track of this output - we're going to need it in the next step</span>
</code></pre></div>    </div>
  </li>
  <li>Go back to the Travis settings page from step 5 to add some environment variables. Make sure you leave the display in build log option disabled. We DO NOT want these secrets to show in our build!
    <ol>
      <li>AZ_LOGIN_NAME - this will come from the ‚Äòname‚Äô property of the output - if you followed my lead the value will be http://travis-azure-blob</li>
      <li>AZ_PASSWORD - a guid generated from the create-for-rbac command, the ‚Äòpassword‚Äô property</li>
      <li>AZ_TENANT - another guid, from the create-for-rbac command‚Äôs ‚Äòtenant‚Äô property</li>
      <li>AZURE_STORAGE_ACCOUNT - the name of your storage account, you‚Äôll need to put your unique name here. Mine was ‚Äúthenickfishazureblobdemo‚Äù</li>
    </ol>

    <p>Your settings should now look like this:
 <img src="assets/img/posts/AzureBlobTravisCi/TravisEnvironmentVariables.jpg" alt="Travis CI Environment Variable Screenshot" title="Travis CI Environment Variable Screenshot" /></p>
  </li>
  <li>Add a travis configuration file to the root of your repository with your web application. Make a file called .travis.yml in the base directory of the repo. The file should look like this:
<script src="https://gist.github.com/thenickfish/566ec98d7523a526a69b4efb90fa1c13.js"></script></li>
  <li>Use git to commit and push your build configuration
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s2">"Add Travis build configuration"</span>
git push origin
</code></pre></div>    </div>
  </li>
  <li>If you check the builds in your Travis CI dashboard, the commit you just pushed to origin should have kicked off a build! Watch the output. With any luck, it should succeed, and you‚Äôll see that it exits at the end with a success code. You should see in the logs that it uploads your website to storage at the very end of the build.</li>
  <li>Go see your website deployed in the cloud! You can get the URL here:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az storage account show <span class="nt">-n</span> thenickfishazureblobdemo <span class="nt">-g</span> azure-blob-demo <span class="nt">--query</span> <span class="s2">"primaryEndpoints.web"</span> <span class="nt">--output</span> tsv
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="wrap-up">Wrap up</h3>
<p>At this point you have the basic build wired up. Make some changes to the website and push them to git, you‚Äôll see them updated shortly after without any more work from you! Now you can easily get your changes deployed to the cloud. Experiment with running your tests (ng test) before deploying so that you won‚Äôt push bad code to Azure when the tests fail. Did I miss anything? Have questions? Let me know in the comments, or feel free to contact me.</p>
:ET